# Test Plan: Document Number Generation Fix

## üìã Test Overview

‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Emergency Fallback ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á

## ‚úÖ Test Cases

### Test 1: Normal Document Creation (Single Request)

**‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå**: ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏Å‡∏ï‡∏¥ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£

**Steps**:
1. ‡πÄ‡∏õ‡∏¥‡∏î console ‡πÉ‡∏ô browser (F12)
2. ‡∏™‡∏£‡πâ‡∏≤‡∏á BOQ ‡πÉ‡∏´‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô UI
3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö logs ‡πÉ‡∏ô console

**Expected Result**:
```
‚úÖ Generated document number: BOQ-2025-10-0001 in <1000ms
```

**Logs ‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏´‡πá‡∏ô**:
- `üî¢ Starting document number generation`
- `üîí Lock acquired after 1 attempts`
- `üìä Counter retrieved in XXXms`
- `‚úÖ Generated document number`
- ‡πÑ‡∏°‡πà‡∏°‡∏µ ‚ö†Ô∏è warnings ‡∏´‡∏£‡∏∑‡∏≠ ‚ùå errors

---

### Test 2: Multiple Documents (Sequential)

**‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå**: ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö

**Steps**:
1. ‡∏™‡∏£‡πâ‡∏≤‡∏á BOQ 5 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏ó‡∏µ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏î‡∏π document numbers

**Expected Result**:
```
BOQ-2025-10-0001
BOQ-2025-10-0002
BOQ-2025-10-0003
BOQ-2025-10-0004
BOQ-2025-10-0005
```

**Checks**:
- [ ] ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏±‡∏ô (‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î)
- [ ] ‡πÑ‡∏°‡πà‡∏°‡∏µ duplicate
- [ ] ‡πÑ‡∏°‡πà‡∏°‡∏µ 9999

---

### Test 3: Concurrent Creation (Stress Test)

**‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå**: ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô

**Steps** (‡πÉ‡∏ä‡πâ Browser Console):

```javascript
// Test concurrent creation
async function testConcurrentCreation(count = 10) {
  console.log(`üß™ Testing ${count} concurrent document creations...`);
  
  const promises = [];
  const startTime = Date.now();
  
  for (let i = 0; i < count; i++) {
    const promise = fetch('/api/documents', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        type: 'boq',
        projectTitle: `Test ${i}`,
        items: []
      })
    }).then(r => r.json());
    
    promises.push(promise);
  }
  
  const results = await Promise.all(promises);
  const endTime = Date.now();
  
  // Extract document numbers
  const docNumbers = results.map(r => r.document?.documentNumber);
  
  // Check for duplicates
  const uniqueNumbers = new Set(docNumbers);
  const hasDuplicates = uniqueNumbers.size !== docNumbers.length;
  
  console.log('Results:', {
    total: count,
    unique: uniqueNumbers.size,
    duplicates: hasDuplicates,
    time: `${endTime - startTime}ms`,
    avgTime: `${(endTime - startTime) / count}ms per request`,
    numbers: Array.from(uniqueNumbers).sort()
  });
  
  if (hasDuplicates) {
    console.error('‚ùå FAIL: Duplicates found!');
    const duplicates = docNumbers.filter((n, i) => docNumbers.indexOf(n) !== i);
    console.error('Duplicate numbers:', duplicates);
  } else {
    console.log('‚úÖ PASS: All numbers are unique');
  }
  
  return { hasDuplicates, docNumbers: Array.from(uniqueNumbers) };
}

// Run test
testConcurrentCreation(10);
```

**Expected Result**:
```javascript
{
  total: 10,
  unique: 10,
  duplicates: false,
  time: "2500ms",
  avgTime: "250ms per request",
  numbers: ["BOQ-2025-10-0001", ..., "BOQ-2025-10-0010"]
}
```

**Checks**:
- [ ] ‡πÑ‡∏°‡πà‡∏°‡∏µ duplicates
- [ ] Total time < 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 10 requests)
- [ ] ‡πÑ‡∏°‡πà‡∏°‡∏µ 9999 ‡πÉ‡∏ô document numbers

---

### Test 4: Database Slow Response Simulation

**‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå**: ‡∏ó‡∏î‡∏™‡∏≠‡∏ö circuit breaker ‡πÅ‡∏•‡∏∞ fallback

**Note**: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‡πÅ‡∏ï‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ monitor logs ‡πÉ‡∏ô production

**What to Monitor**:
```
# ‡∏ñ‡πâ‡∏≤ database ‡∏ä‡πâ‡∏≤ ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏´‡πá‡∏ô:
‚ö†Ô∏è KV is marked unhealthy (3 failures, last XXXms ago)
üîÑ Attempting KV health recovery...

# ‡∏ñ‡πâ‡∏≤ recovery ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:
‚úÖ KV health restored after operation: generateDocumentNumber:getCounter
```

**Checks**:
- [ ] Circuit breaker activate ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤
- [ ] Auto-recovery ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
- [ ] Fallback ‡πÉ‡∏ä‡πâ timestamp (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà 9999)

---

### Test 5: Month Transition

**‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå**: ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô counter ‡∏ï‡πâ‡∏≠‡∏á reset

**Steps**:
1. ‡∏™‡∏£‡πâ‡∏≤‡∏á BOQ ‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‚Üí ‡πÑ‡∏î‡πâ `BOQ-2025-10-0001`
2. (‡∏à‡∏≥‡∏•‡∏≠‡∏á) ‡∏ñ‡πâ‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‚Üí ‡∏Ñ‡∏ß‡∏£‡πÑ‡∏î‡πâ `BOQ-2025-11-0001`

**Manual Test** (‡∏ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô):
- ‡∏™‡∏£‡πâ‡∏≤‡∏á BOQ ‡∏ß‡∏±‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
- ‡∏£‡∏≠‡πÄ‡∏•‡∏¢ 00:00 ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà
- ‡∏™‡∏£‡πâ‡∏≤‡∏á BOQ ‡πÉ‡∏´‡∏°‡πà
- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ counter reset ‡πÄ‡∏õ‡πá‡∏ô 0001

**Expected**:
```
‡πÄ‡∏î‡∏∑‡∏≠‡∏ô 10: BOQ-2025-10-0042
‡πÄ‡∏î‡∏∑‡∏≠‡∏ô 11: BOQ-2025-11-0001  ‚Üê reset counter
```

---

### Test 6: Lock Cleanup (Stale Lock)

**‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå**: ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ stale locks ‡∏ñ‡∏π‡∏Å cleanup

**Scenario**: 
- Server crash ‡∏Ç‡∏ì‡∏∞‡∏ñ‡∏∑‡∏≠ lock
- Lock ‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏ô database
- Request ‡πÉ‡∏´‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á detect ‡πÅ‡∏•‡∏∞ cleanup

**Expected Behavior**:
```
‚ö†Ô∏è Stale lock detected (age: 35000ms), attempting to clear
üîí Lock acquired after clearing stale lock
```

**Note**: ‡∏¢‡∏≤‡∏Å‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏•‡∏≠‡∏á ‡πÅ‡∏ï‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏µ auto-cleanup ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö locks ‡∏≠‡∏≤‡∏¢‡∏∏ > 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ

---

## üîç Monitoring Checklist

### During Testing

‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö logs ‡πÉ‡∏ô browser console:

- [ ] ‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ `üö® CRITICAL: Emergency fallback triggered`
- [ ] ‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ `‚ö†Ô∏è All 15 attempts failed`
- [ ] ‚úÖ Lock acquisition ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÉ‡∏ô attempt ‡πÅ‡∏£‡∏Å (> 90%)
- [ ] ‚úÖ Response time < 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö normal requests
- [ ] ‚úÖ Document numbers ‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô

### Performance Metrics

| Metric | Target | Your Result | Pass/Fail |
|--------|--------|-------------|-----------|
| Lock Acquisition (1st attempt) | > 90% | ___% | _____ |
| Avg Response Time | < 1s | ___ms | _____ |
| P95 Response Time | < 2s | ___ms | _____ |
| P99 Response Time | < 5s | ___ms | _____ |
| Success Rate | > 99% | ___% | _____ |
| Duplicates | 0 | ___ | _____ |
| Emergency Fallbacks | 0 | ___ | _____ |

---

## üìä Success Criteria

### Must Have (P0)
- ‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ duplicate document numbers
- ‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ emergency fallback (9999 ‡∏´‡∏£‡∏∑‡∏≠ timestamp fallback)
- ‚úÖ ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö
- ‚úÖ Response time < 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (P99)

### Should Have (P1)
- ‚úÖ Lock acquisition ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÉ‡∏ô attempt ‡πÅ‡∏£‡∏Å (> 90%)
- ‚úÖ Response time < 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (P50)
- ‚úÖ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö concurrent requests (10+ simultaneous)
- ‚úÖ Circuit breaker ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á

### Nice to Have (P2)
- ‚úÖ Detailed performance logs
- ‚úÖ Automatic stale lock cleanup
- ‚úÖ Health status tracking

---

## üêõ Common Issues & Solutions

### Issue 1: ‡∏¢‡∏±‡∏á‡πÄ‡∏´‡πá‡∏ô 9999 ‡πÉ‡∏ô document numbers

**Symptoms**: `BOQ-2025-10-9999`

**Root Cause**: Code ‡πÄ‡∏Å‡πà‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà deploy ‡∏´‡∏£‡∏∑‡∏≠ cache issue

**Solution**:
```bash
# Clear browser cache
Ctrl+Shift+R (hard reload)

# Verify server code
curl https://your-api/version
# ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏´‡πá‡∏ô version 2.0.0
```

---

### Issue 2: Duplicate Document Numbers

**Symptoms**: ‡∏´‡∏•‡∏≤‡∏¢ documents ‡∏°‡∏µ number ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô

**Root Cause**: Lock mechanism ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß

**Debug**:
```javascript
// Check logs ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö:
"Lock acquired after X attempts"
"Lock verification failed"
```

**Solution**: Check database performance ‡πÅ‡∏•‡∏∞ index

---

### Issue 3: Slow Response Time (> 10s)

**Symptoms**: ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≤‡∏ô‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á document

**Root Cause**: Database slow ‡∏´‡∏£‡∏∑‡∏≠ timeout issues

**Debug**:
```javascript
// Check logs ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö timing:
"Counter retrieved in XXXms"  // ‡∏Ñ‡∏ß‡∏£ < 1000ms
"Uniqueness check completed in XXXms"  // ‡∏Ñ‡∏ß‡∏£ < 2000ms
```

**Solution**:
1. Check database connection
2. Check Supabase dashboard ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö performance
3. ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤ increase timeout ‡∏´‡∏£‡∏∑‡∏≠ upgrade plan

---

### Issue 4: Circuit Breaker Always Open

**Symptoms**: 
```
‚ö†Ô∏è KV is marked unhealthy
```

**Root Cause**: Database ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á

**Solution**:
1. Check Supabase status
2. Verify database indexes
3. Check network connectivity
4. Review recent changes

---

## üìù Test Report Template

```markdown
# Document Number Fix Test Report

**Date**: _____________
**Tester**: _____________
**Environment**: Production / Staging / Development

## Test Results

| Test Case | Status | Notes |
|-----------|--------|-------|
| Single Document Creation | ‚úÖ/‚ùå | |
| Sequential Creation (5 docs) | ‚úÖ/‚ùå | |
| Concurrent Creation (10 docs) | ‚úÖ/‚ùå | |
| No Duplicates | ‚úÖ/‚ùå | |
| No 9999 Numbers | ‚úÖ/‚ùå | |

## Performance

- Avg Response Time: ___ms
- P95 Response Time: ___ms
- P99 Response Time: ___ms
- Lock Success Rate (1st attempt): ___%

## Issues Found

1. ___________________
2. ___________________

## Recommendations

1. ___________________
2. ___________________

## Conclusion

‚úÖ PASS / ‚ùå FAIL

**Approved for Production**: YES / NO
```

---

## üöÄ Quick Test Commands

```javascript
// 1. Quick single test
fetch('/api/documents', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ type: 'boq', projectTitle: 'Test', items: [] })
}).then(r => r.json()).then(console.log);

// 2. Quick concurrent test (paste in console)
Promise.all(Array(10).fill(0).map((_, i) => 
  fetch('/api/documents', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ type: 'boq', projectTitle: `Test ${i}`, items: [] })
  }).then(r => r.json())
)).then(results => {
  const numbers = results.map(r => r.document?.documentNumber);
  console.log('Numbers:', numbers);
  console.log('Unique:', new Set(numbers).size === numbers.length ? '‚úÖ' : '‚ùå FAIL');
});

// 3. Check version
fetch('/api/version').then(r => r.json()).then(console.log);
```

---

**Happy Testing! üéâ**
