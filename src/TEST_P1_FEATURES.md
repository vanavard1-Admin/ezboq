# üß™ P1 System Stability Testing Guide

## ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Input Validation, Rate Limiting, ‡πÅ‡∏•‡∏∞ Document Number Schema

---

## 1Ô∏è‚É£ Input Validation (Zod) Testing

### 1.1 ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Valid Customer Data (‡∏Ñ‡∏ß‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à)

```bash
curl -X POST \
  https://YOUR_PROJECT.supabase.co/functions/v1/make-server-6e95bca3/customers \
  -H "Authorization: Bearer YOUR_ANON_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "id": "cust-valid-001",
    "name": "‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡∏à‡∏≥‡∏Å‡∏±‡∏î",
    "taxId": "1234567890123",
    "address": "123 ‡∏ñ‡∏ô‡∏ô‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø 10110",
    "phone": "02-123-4567",
    "email": "test@company.com"
  }'
```

**‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á**:
```json
{
  "success": true,
  "customer": {
    "id": "cust-valid-001",
    "name": "‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡∏à‡∏≥‡∏Å‡∏±‡∏î",
    ...
  }
}
```

**Status**: `200 OK`

---

### 1.2 ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Invalid Customer Data - Missing Required Field

```bash
curl -X POST \
  https://YOUR_PROJECT.supabase.co/functions/v1/make-server-6e95bca3/customers \
  -H "Authorization: Bearer YOUR_ANON_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "id": "cust-invalid-001",
    "name": ""
  }'
```

**‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á**:
```json
{
  "error": "Invalid customer data",
  "details": [
    {
      "path": "name",
      "message": "String must contain at least 1 character(s)"
    }
  ]
}
```

**Status**: `400 Bad Request`

---

### 1.3 ‡∏ó‡∏î‡∏™‡∏≠‡∏ö XSS Attack Prevention

```bash
curl -X POST \
  https://YOUR_PROJECT.supabase.co/functions/v1/make-server-6e95bca3/customers \
  -H "Authorization: Bearer YOUR_ANON_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "id": "cust-xss-001",
    "name": "<script>alert(\"XSS\")</script>",
    "address": "<img src=x onerror=alert(1)>",
    "email": "test@test.com"
  }'
```

**‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á**:
```json
{
  "success": true,
  "customer": {
    "id": "cust-xss-001",
    "name": "<script>alert(&quot;XSS&quot;)</script>",
    "address": "<img src=x onerror=alert(1)>"
  }
}
```

‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å sanitized (HTML tags escaped)

---

### 1.4 ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Invalid Email Format

```bash
curl -X POST \
  https://YOUR_PROJECT.supabase.co/functions/v1/make-server-6e95bca3/customers \
  -H "Authorization: Bearer YOUR_ANON_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "id": "cust-invalid-email",
    "name": "Test Company",
    "email": "not-an-email"
  }'
```

**‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á**:
```json
{
  "error": "Invalid customer data",
  "details": [
    {
      "path": "email",
      "message": "Invalid email"
    }
  ]
}
```

**Status**: `400 Bad Request`

---

### 1.5 ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Document Validation - Invalid Type

```bash
curl -X POST \
  https://YOUR_PROJECT.supabase.co/functions/v1/make-server-6e95bca3/documents \
  -H "Authorization: Bearer YOUR_ANON_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "id": "doc-invalid-001",
    "type": "invalid-type",
    "status": "draft",
    "projectTitle": "Test Project"
  }'
```

**‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á**:
```json
{
  "error": "Invalid document data",
  "details": [
    {
      "path": "type",
      "message": "Invalid enum value. Expected 'boq' | 'quotation' | 'invoice' | 'receipt', received 'invalid-type'"
    }
  ]
}
```

**Status**: `400 Bad Request`

---

### 1.6 ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Document Validation - Negative Amount

```bash
curl -X POST \
  https://YOUR_PROJECT.supabase.co/functions/v1/make-server-6e95bca3/documents \
  -H "Authorization: Bearer YOUR_ANON_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "id": "doc-negative",
    "type": "invoice",
    "status": "draft",
    "projectTitle": "Test",
    "totalAmount": -1000
  }'
```

**‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á**:
```json
{
  "error": "Invalid document data",
  "details": [
    {
      "path": "totalAmount",
      "message": "Number must be greater than or equal to 0"
    }
  ]
}
```

---

## 2Ô∏è‚É£ Rate Limiting Testing

### 2.1 ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Normal Usage (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô limit)

```bash
# ‡∏™‡πà‡∏á 10 requests ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 1 ‡∏ô‡∏≤‡∏ó‡∏µ
for i in {1..10}; do
  echo "Request $i"
  curl -s -w "\nStatus: %{http_code}\n" \
    https://YOUR_PROJECT.supabase.co/functions/v1/make-server-6e95bca3/customers \
    -H "Authorization: Bearer YOUR_ANON_KEY" | grep -E "(customers|Status)"
  sleep 0.5
done
```

**‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á**:
- ‡∏ó‡∏∏‡∏Å request ‡πÑ‡∏î‡πâ `Status: 200`
- Response headers ‡∏°‡∏µ `X-RateLimit-Remaining` ‡∏•‡∏î‡∏•‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢‡πÜ

---

### 2.2 ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Rate Limit Exceeded

```bash
# ‡∏™‡πà‡∏á 105 requests ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 1 ‡∏ô‡∏≤‡∏ó‡∏µ (‡πÄ‡∏Å‡∏¥‡∏ô limit 100)
for i in {1..105}; do
  response=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
    https://YOUR_PROJECT.supabase.co/functions/v1/make-server-6e95bca3/customers \
    -H "Authorization: Bearer YOUR_ANON_KEY")
  
  http_code=$(echo "$response" | grep "HTTP_CODE:" | cut -d: -f2)
  
  if [ "$http_code" == "429" ]; then
    echo "‚ùå Request $i: Rate limit exceeded (429)"
  elif [ "$http_code" == "200" ]; then
    echo "‚úÖ Request $i: Success (200)"
  fi
done
```

**‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á**:
- Request 1-100: `Status: 200 OK`
- Request 101-105: `Status: 429 Too Many Requests`

**Response ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 429**:
```json
{
  "error": "Rate limit exceeded",
  "message": "Maximum 100 requests per minute. Please try again later.",
  "retryAfter": 60
}
```

**Response Headers**:
```
Retry-After: 60
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 0
X-RateLimit-Reset: 1706444400
```

---

### 2.3 ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Rate Limit Headers

```bash
curl -v \
  https://YOUR_PROJECT.supabase.co/functions/v1/make-server-6e95bca3/customers \
  -H "Authorization: Bearer YOUR_ANON_KEY" \
  2>&1 | grep -i "x-ratelimit"
```

**‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á**:
```
< X-RateLimit-Limit: 100
< X-RateLimit-Remaining: 99
< X-RateLimit-Reset: 1706444460
```

---

### 2.4 ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Rate Limit Reset (‡∏´‡∏•‡∏±‡∏á 1 ‡∏ô‡∏≤‡∏ó‡∏µ)

```bash
# ‡∏ó‡∏î‡∏™‡∏≠‡∏ö request ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å rate limit reset
echo "Waiting for rate limit reset (60 seconds)..."
sleep 60

curl -s \
  https://YOUR_PROJECT.supabase.co/functions/v1/make-server-6e95bca3/customers \
  -H "Authorization: Bearer YOUR_ANON_KEY" \
  | jq '.customers | length'
```

**‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á**:
- ‡πÑ‡∏î‡πâ `Status: 200 OK`
- `X-RateLimit-Remaining` ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô 99 ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á

---

### 2.5 ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Rate Limit ‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö Health Endpoints

```bash
# ‡∏™‡πà‡∏á 150 requests ‡πÑ‡∏õ‡∏ó‡∏µ‡πà /livez (‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡∏ñ‡∏π‡∏Å rate limit)
for i in {1..150}; do
  status=$(curl -s -o /dev/null -w "%{http_code}" \
    https://YOUR_PROJECT.supabase.co/functions/v1/make-server-6e95bca3/livez)
  
  if [ "$status" != "200" ]; then
    echo "‚ùå Request $i failed: $status"
  fi
done

echo "‚úÖ All health check requests succeeded"
```

**‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á**:
- ‡∏ó‡∏∏‡∏Å request ‡πÑ‡∏î‡πâ `200 OK`
- Health endpoints ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å rate limit

---

## 3Ô∏è‚É£ Document Number Schema Testing

### 3.1 ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Sequential Document Numbers

```bash
# ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ 5 ‡∏â‡∏ö‡∏±‡∏ö
for i in {1..5}; do
  response=$(curl -s -X POST \
    https://YOUR_PROJECT.supabase.co/functions/v1/make-server-6e95bca3/documents \
    -H "Authorization: Bearer YOUR_ANON_KEY" \
    -H "Content-Type: application/json" \
    -d "{
      \"id\": \"doc-test-$i\",
      \"type\": \"invoice\",
      \"status\": \"draft\",
      \"projectTitle\": \"Test Project $i\"
    }")
  
  docNumber=$(echo "$response" | jq -r '.document.documentNumber')
  echo "Document $i: $docNumber"
done
```

**‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á**:
```
Document 1: INV-2025-01-0001
Document 2: INV-2025-01-0002
Document 3: INV-2025-01-0003
Document 4: INV-2025-01-0004
Document 5: INV-2025-01-0005
```

‚úÖ ‡πÄ‡∏•‡∏Ç‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏ö‡∏ö‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á

---

### 3.2 ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Different Document Types

```bash
# ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
types=("boq" "quotation" "invoice" "receipt")

for type in "${types[@]}"; do
  response=$(curl -s -X POST \
    https://YOUR_PROJECT.supabase.co/functions/v1/make-server-6e95bca3/documents \
    -H "Authorization: Bearer YOUR_ANON_KEY" \
    -H "Content-Type: application/json" \
    -d "{
      \"id\": \"doc-$type-001\",
      \"type\": \"$type\",
      \"status\": \"draft\",
      \"projectTitle\": \"Test $type\"
    }")
  
  docNumber=$(echo "$response" | jq -r '.document.documentNumber')
  echo "$type: $docNumber"
done
```

**‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á**:
```
boq: BOQ-2025-01-0001
quotation: QT-2025-01-0001
invoice: INV-2025-01-0001
receipt: RCP-2025-01-0001
```

‚úÖ ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏°‡∏µ counter ‡πÅ‡∏¢‡∏Å‡∏Å‡∏±‡∏ô

---

### 3.3 ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Uniqueness Constraint

```bash
# ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢ document number ‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô
curl -X POST \
  https://YOUR_PROJECT.supabase.co/functions/v1/make-server-6e95bca3/documents \
  -H "Authorization: Bearer YOUR_ANON_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "id": "doc-duplicate-1",
    "type": "invoice",
    "status": "draft",
    "projectTitle": "First",
    "documentNumber": "INV-2025-01-0001"
  }'

# ‡∏•‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏î‡πâ‡∏ß‡∏¢ ID ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô ‡πÅ‡∏ï‡πà documentNumber ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
curl -X POST \
  https://YOUR_PROJECT.supabase.co/functions/v1/make-server-6e95bca3/documents \
  -H "Authorization: Bearer YOUR_ANON_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "id": "doc-duplicate-2",
    "type": "invoice",
    "status": "draft",
    "projectTitle": "Second",
    "documentNumber": "INV-2025-01-0001"
  }'
```

**‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á**:
- ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 1: ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏´‡∏£‡∏∑‡∏≠ auto-generate number ‡πÉ‡∏´‡∏°‡πà)
- ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 2: ‡πÉ‡∏ä‡πâ document number ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞ auto-generate number ‡πÉ‡∏´‡∏°‡πà)

---

### 3.4 ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Document Number Format

```bash
# ‡∏î‡∏∂‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö format
curl -s \
  https://YOUR_PROJECT.supabase.co/functions/v1/make-server-6e95bca3/documents \
  -H "Authorization: Bearer YOUR_ANON_KEY" \
  | jq -r '.documents[].documentNumber' \
  | grep -E '^(BOQ|QT|INV|RCP)-[0-9]{4}-[0-9]{2}-[0-9]{4}$'
```

**‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á**:
```
INV-2025-01-0001
INV-2025-01-0002
QT-2025-01-0001
BOQ-2025-01-0001
```

‚úÖ ‡∏ó‡∏∏‡∏Å document number ‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏° format `{PREFIX}-{YYYY}-{MM}-{####}`

---

### 3.5 ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Counter Reset (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà)

**‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏**: ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‡∏´‡∏£‡∏∑‡∏≠ manually ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç system date

```bash
# Simulate: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà
# (‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏à‡∏£‡∏¥‡∏á ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏à‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)

# ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
curl -s -X POST ... | jq -r '.document.documentNumber'
# Output: INV-2025-01-0005

# ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (‡∏™‡∏°‡∏°‡∏ï‡∏¥)
curl -s -X POST ... | jq -r '.document.documentNumber'
# Output: INV-2025-02-0001
```

‚úÖ Counter reset ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô 0001 ‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà

---

## 4Ô∏è‚É£ Integration Testing

### 4.1 ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Full Workflow (BOQ ‚Üí Quotation ‚Üí Invoice ‚Üí Receipt)

```bash
#!/bin/bash

echo "üìã Creating BOQ..."
boq=$(curl -s -X POST \
  https://YOUR_PROJECT.supabase.co/functions/v1/make-server-6e95bca3/documents \
  -H "Authorization: Bearer YOUR_ANON_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "id": "doc-workflow-boq",
    "type": "boq",
    "status": "draft",
    "projectTitle": "Integration Test Project",
    "boqItems": [
      {"id": "1", "description": "Cement", "quantity": 100, "unit": "bag", "material": 150, "labor": 50}
    ]
  }')

boqNumber=$(echo "$boq" | jq -r '.document.documentNumber')
echo "‚úÖ BOQ created: $boqNumber"

sleep 1

echo "üí∞ Creating Quotation..."
qt=$(curl -s -X POST \
  https://YOUR_PROJECT.supabase.co/functions/v1/make-server-6e95bca3/documents \
  -H "Authorization: Bearer YOUR_ANON_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "id": "doc-workflow-qt",
    "type": "quotation",
    "status": "draft",
    "projectTitle": "Integration Test Project"
  }')

qtNumber=$(echo "$qt" | jq -r '.document.documentNumber')
echo "‚úÖ Quotation created: $qtNumber"

sleep 1

echo "üßæ Creating Invoice..."
inv=$(curl -s -X POST \
  https://YOUR_PROJECT.supabase.co/functions/v1/make-server-6e95bca3/documents \
  -H "Authorization: Bearer YOUR_ANON_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "id": "doc-workflow-inv",
    "type": "invoice",
    "status": "draft",
    "projectTitle": "Integration Test Project"
  }')

invNumber=$(echo "$inv" | jq -r '.document.documentNumber')
echo "‚úÖ Invoice created: $invNumber"

sleep 1

echo "üìÉ Creating Receipt..."
rcp=$(curl -s -X POST \
  https://YOUR_PROJECT.supabase.co/functions/v1/make-server-6e95bca3/documents \
  -H "Authorization: Bearer YOUR_ANON_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "id": "doc-workflow-rcp",
    "type": "receipt",
    "status": "draft",
    "projectTitle": "Integration Test Project"
  }')

rcpNumber=$(echo "$rcp" | jq -r '.document.documentNumber')
echo "‚úÖ Receipt created: $rcpNumber"

echo ""
echo "üéâ Workflow Complete!"
echo "   BOQ:       $boqNumber"
echo "   Quotation: $qtNumber"
echo "   Invoice:   $invNumber"
echo "   Receipt:   $rcpNumber"
```

**‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á**:
```
üìã Creating BOQ...
‚úÖ BOQ created: BOQ-2025-01-0001
üí∞ Creating Quotation...
‚úÖ Quotation created: QT-2025-01-0001
üßæ Creating Invoice...
‚úÖ Invoice created: INV-2025-01-0001
üìÉ Creating Receipt...
‚úÖ Receipt created: RCP-2025-01-0001

üéâ Workflow Complete!
   BOQ:       BOQ-2025-01-0001
   Quotation: QT-2025-01-0001
   Invoice:   INV-2025-01-0001
   Receipt:   RCP-2025-01-0001
```

---

## 5Ô∏è‚É£ Performance Testing

### 5.1 ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Concurrent Document Creation

```bash
# ‡∏™‡∏£‡πâ‡∏≤‡∏á 10 documents ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô (simulate concurrent users)
for i in {1..10}; do
  (curl -s -X POST \
    https://YOUR_PROJECT.supabase.co/functions/v1/make-server-6e95bca3/documents \
    -H "Authorization: Bearer YOUR_ANON_KEY" \
    -H "Content-Type: application/json" \
    -d "{
      \"id\": \"doc-concurrent-$i\",
      \"type\": \"invoice\",
      \"status\": \"draft\",
      \"projectTitle\": \"Concurrent Test $i\"
    }" | jq -r '.document.documentNumber') &
done

wait
echo "‚úÖ All concurrent requests completed"
```

**‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á**:
- ‡∏ó‡∏∏‡∏Å document ‡∏°‡∏µ document number ‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô
- ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏î race condition

---

### 5.2 üå™Ô∏è ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Concurrent Storm (Document Number + Idempotency)

**‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå**: ‡∏ó‡∏î‡∏™‡∏≠‡∏ö race conditions, unique constraints, ‡πÅ‡∏•‡∏∞ idempotency ‡∏†‡∏≤‡∏¢‡πÉ‡∏ï‡πâ high load

```bash
#!/bin/bash

echo "üå™Ô∏è Starting Concurrent Storm Test..."
echo "üìä Config: 50 concurrent requests in 5 seconds"
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"

# Generate unique idempotency key for each request
BASE_KEY="storm-test-$(date +%s)"
RESULTS_FILE="/tmp/storm-test-results.txt"
rm -f $RESULTS_FILE

# Function to create document with idempotency
create_document() {
  local id=$1
  local idempotency_key="${BASE_KEY}-${id}"
  
  response=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
    -X POST \
    https://YOUR_PROJECT.supabase.co/functions/v1/make-server-6e95bca3/documents \
    -H "Authorization: Bearer YOUR_ANON_KEY" \
    -H "Content-Type: application/json" \
    -H "Idempotency-Key: ${idempotency_key}" \
    -d "{
      \"id\": \"doc-storm-${id}\",
      \"type\": \"invoice\",
      \"status\": \"draft\",
      \"projectTitle\": \"Storm Test ${id}\"
    }")
  
  http_code=$(echo "$response" | grep "HTTP_CODE:" | cut -d: -f2)
  doc_number=$(echo "$response" | jq -r '.document.documentNumber' 2>/dev/null || echo "ERROR")
  
  echo "${id}|${http_code}|${doc_number}" >> $RESULTS_FILE
}

# Launch 50 concurrent requests
for i in {1..50}; do
  create_document $i &
  
  # Stagger slightly to avoid overwhelming the system
  if [ $((i % 10)) -eq 0 ]; then
    sleep 0.1
  fi
done

echo "‚è≥ Waiting for all requests to complete..."
wait

echo "‚úÖ All requests completed!"
echo ""
echo "üìä Results Analysis:"
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"

# Analyze results
total=$(wc -l < $RESULTS_FILE)
success=$(grep "|200|" $RESULTS_FILE | wc -l)
failures=$(grep -v "|200|" $RESULTS_FILE | wc -l)

echo "Total requests: $total"
echo "‚úÖ Success (200): $success"
echo "‚ùå Failures: $failures"
echo ""

# Check for duplicate document numbers
echo "üîç Checking for duplicate document numbers..."
doc_numbers=$(awk -F'|' '{print $3}' $RESULTS_FILE | grep -v "ERROR" | sort)
duplicates=$(echo "$doc_numbers" | uniq -d)

if [ -z "$duplicates" ]; then
  echo "‚úÖ No duplicate document numbers found!"
else
  echo "‚ùå DUPLICATE DOCUMENT NUMBERS DETECTED:"
  echo "$duplicates"
fi

echo ""
echo "üìù Document numbers generated:"
echo "$doc_numbers" | head -10
echo "... (showing first 10)"

# Test idempotency: Retry same request
echo ""
echo "üîÑ Testing Idempotency (retry same request)..."
first_id="1"
first_key="${BASE_KEY}-${first_id}"

retry1=$(curl -s -X POST \
  https://YOUR_PROJECT.supabase.co/functions/v1/make-server-6e95bca3/documents \
  -H "Authorization: Bearer YOUR_ANON_KEY" \
  -H "Content-Type: application/json" \
  -H "Idempotency-Key: ${first_key}" \
  -d "{
    \"id\": \"doc-storm-${first_id}\",
    \"type\": \"invoice\",
    \"status\": \"draft\",
    \"projectTitle\": \"Storm Test ${first_id}\"
  }")

retry2=$(curl -s -X POST \
  https://YOUR_PROJECT.supabase.co/functions/v1/make-server-6e95bca3/documents \
  -H "Authorization: Bearer YOUR_ANON_KEY" \
  -H "Content-Type: application/json" \
  -H "Idempotency-Key: ${first_key}" \
  -d "{
    \"id\": \"doc-storm-${first_id}\",
    \"type\": \"invoice\",
    \"status\": \"draft\",
    \"projectTitle\": \"Storm Test ${first_id}\"
  }")

doc_num1=$(echo "$retry1" | jq -r '.document.documentNumber')
doc_num2=$(echo "$retry2" | jq -r '.document.documentNumber')

if [ "$doc_num1" == "$doc_num2" ]; then
  echo "‚úÖ Idempotency working: Same document number ($doc_num1) returned"
else
  echo "‚ùå Idempotency failed: Different document numbers ($doc_num1 vs $doc_num2)"
fi

echo ""
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
echo "üéâ Storm Test Complete!"
```

**‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á**:
```
üå™Ô∏è Starting Concurrent Storm Test...
üìä Config: 50 concurrent requests in 5 seconds
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚è≥ Waiting for all requests to complete...
‚úÖ All requests completed!

üìä Results Analysis:
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Total requests: 50
‚úÖ Success (200): 50
‚ùå Failures: 0

üîç Checking for duplicate document numbers...
‚úÖ No duplicate document numbers found!

üìù Document numbers generated:
INV-2025-01-0001
INV-2025-01-0002
INV-2025-01-0003
INV-2025-01-0004
INV-2025-01-0005
INV-2025-01-0006
INV-2025-01-0007
INV-2025-01-0008
INV-2025-01-0009
INV-2025-01-0010
... (showing first 10)

üîÑ Testing Idempotency (retry same request)...
‚úÖ Idempotency working: Same document number (INV-2025-01-0001) returned

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
üéâ Storm Test Complete!
```

**Test Criteria**:
- ‚úÖ ‡∏ó‡∏∏‡∏Å request ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (200 OK)
- ‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ document number ‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô
- ‚úÖ Idempotency ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (retry ‡πÑ‡∏î‡πâ response ‡πÄ‡∏î‡∏¥‡∏°)
- ‚úÖ ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏î race condition
- ‚úÖ System ‡πÑ‡∏°‡πà crash ‡∏´‡∏£‡∏∑‡∏≠ timeout

---

### 5.3 üí• ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Extreme Storm (100 Requests)

```bash
#!/bin/bash

echo "üí• EXTREME STORM TEST: 100 concurrent requests"
echo "‚ö†Ô∏è  This will test system limits!"

# Same script as above, but with 100 requests
for i in {1..100}; do
  create_document $i &
done

wait
echo "‚úÖ Extreme storm test completed!"
```

**Expected Behavior**:
- Some requests may hit rate limit (429)
- But no duplicate document numbers should occur
- System should gracefully handle the load
- No data corruption

---

## ‚úÖ Test Checklist

### Input Validation
- [ ] Valid data passes validation
- [ ] Missing required fields rejected
- [ ] Invalid email format rejected
- [ ] Negative amounts rejected
- [ ] Invalid enum values rejected
- [ ] XSS attempts sanitized
- [ ] SQL injection prevented

### Rate Limiting
- [ ] Normal usage (< 100 req/min) works
- [ ] Excess requests (> 100 req/min) return 429
- [ ] Rate limit headers present
- [ ] Rate limit resets after 1 minute
- [ ] Health endpoints not rate limited
- [ ] Different IPs have separate limits

### Document Number Schema
- [ ] Sequential numbers (0001, 0002, 0003...)
- [ ] Different types have separate counters
- [ ] Format matches `{PREFIX}-{YYYY}-{MM}-{####}`
- [ ] Counter resets monthly
- [ ] No duplicate document numbers
- [ ] Concurrent creation doesn't cause collisions

### Integration
- [ ] Full workflow (BOQ ‚Üí QT ‚Üí INV ‚Üí RCP) works
- [ ] All documents created successfully
- [ ] All endpoints work together

---

## üìö Additional Resources

- [SECURITY_RLS_GUIDE.md](./SECURITY_RLS_GUIDE.md) - RLS Setup
- [TEST_SECURITY.md](./TEST_SECURITY.md) - Security Testing
- [Zod Documentation](https://zod.dev/)

---

**Created by**: EZBOQ Development Team  
**Last Updated**: 28 January 2025  
**Version**: 1.1.0
